@page "/trailers/"
@page "/trailers/{TrailerId:guid?}"
@using Microsoft.JSInterop
@using OutsourceTracker.ModelService.Requests.Trailers
@using OutsourceTracker.Models.Trailers
@using OutsourceTracker.Services
@inject IJSRuntime JSRuntime

<ConfirmationModal IsVisible="@showDeleteModal" Title="Confirm Delete" Message="Are you sure you want to delete this trailer?" OnResponse="OnDeleteConfirmation" YesButtonText="Delete" NoButtonText="Cancel" />
<LocationRequestModal IsVisible="@showSpotModal" Latitude="selectedTrailer?.SpottedLatitude" Longitude="selectedTrailer?.SpottedLongitude" Accuracy="selectedTrailer?.SpottedAccuracy" LocationUpdated="OnSpotTrailer" />
<div class="container-fluid p-3" style="height: calc(100vh - 80px); overflow: hidden;">
    <div class="row" style="height: 100%;">
        <!-- Left Side: Scrollable, Selectable Trailer List -->
        <div class="col-md-4 d-flex flex-column h-100 mobile-height-adjust">
            <h5 class="mb-2">Trailer List</h5>
            <div class="list-group overflow-auto flex-grow-1 trailer-list">
                @if (trailers != null)
                {
                    @if (trailers.Any())
                    {
                        @foreach (var trailer in trailers)
                        {
                            <div class="list-group-item list-group-item-action @(selectedTrailer?.Id == trailer.Id ? "active" : "")"
                                 @onclick="() => SelectTrailer(trailer)">
                                <div class="d-flex justify-content-between">
                                    <span>Trailer @trailer.Prefix @trailer.Name</span>
                                    <span>Status: Active</span>  @* Placeholder; fetch real data *@
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="p-3">There are no trailers :(</p>
                    }
                }
                else
                {
                    <p class="p-3">Loading trailers...</p>
                }
            </div>
        </div>

        <!-- Right Side: Details (Top) and Map (Bottom) -->
        <div class="col-md-8 d-flex flex-column h-100">
            <!-- Right Side Top: Trailer Details -->
            <div class="d-flex flex-column" style="flex: 0 0 auto; overflow-y: auto;">
                @* Fit to content with auto overflow *@
                <h5 class="mb-2">Trailer Details</h5>
                @if (selectedTrailer != null)
                {
                    <div class="card p-3">
                        <div class="row">
                            <div class="col-12 col-md-6"><strong>Prefix:</strong> @selectedTrailer.Prefix</div>
                            <div class="col-12 col-md-6"><strong>Number:</strong> @selectedTrailer.Name</div>
                        </div>
                        @if (selectedTrailer.SpottedLatitude.HasValue && selectedTrailer.SpottedLongitude.HasValue)
                        {
                            <div class="row mt-2">
                                <div class="col-12 col-md-6"><strong>Location:</strong> @(Math.Abs(selectedTrailer.SpottedLatitude.Value).ToString("F6")) @(selectedTrailer.SpottedLatitude.Value >= 0 ? "N" : "S") @(Math.Abs(selectedTrailer.SpottedLongitude.Value).ToString("F6")) @(selectedTrailer.SpottedLongitude.Value >= 0 ? "E" : "W") ± @selectedTrailer.SpottedAccuracy m</div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-12 col-md-6"><strong>Last Seen:</strong> @selectedTrailer.SpottedOn!.Value.ToLocalTime()</div>
                                <div class="col-12 col-md-6"><strong>Seen By:</strong> @selectedTrailer.SpottedBy</div>
                            </div>
                        }
                        <div class="mt-3">
                            <button class="btn btn-primary me-1" @onclick="ShowTrailerDetails">Details</button>
                            <button class="btn btn-secondary me-2" @onclick="SpotTrailer">Spot</button>
                            <button class="btn btn-danger" @onclick="DeleteTrailer">Delete</button>
                        </div>
                    </div>
                }
                else
                {
                    <p class="p-3">Select a trailer to view details.</p>
                }
            </div>

            <!-- Right Side Bottom: Map -->
            <div class="d-flex flex-column mt-3 flex-grow-1">
                @* Expand to fill remaining space *@
                <h5 class="mb-2">Trailer Map</h5>
                <div id="map" class="border flex-grow-1" style="min-height: 0;"></div>
            </div>
        </div>
    </div>
</div>

@code {
    private List<TrailerViewModel> trailers;
    private TrailerViewModel? selectedTrailer;
    private bool mapInitialized = false;
    private bool showDeleteModal = false;
    private bool showSpotModal = false;
    [Inject] private TrailerService dataSource { get; set; } = null!;
    [Inject] private NavigationManager Navigation { get; set; } = default!;
    [Parameter] public Guid? TrailerId { get; set; }

    protected override async Task OnInitializedAsync()
    {
        trailers = await dataSource.Find().ToListAsync();

        if (TrailerId.HasValue)
        {
            selectedTrailer = trailers.Find(t => t.Id == TrailerId.Value);
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Initialize Leaflet map once (use JS interop)
            await JSRuntime.InvokeVoidAsync("initMap", "map");  // Calls JS function to set up map
            mapInitialized = true;
        }
        if (selectedTrailer != null && selectedTrailer.SpottedLatitude.HasValue && selectedTrailer.SpottedLongitude.HasValue && mapInitialized)
        {
            // Update map marker for selected trailer
            await JSRuntime.InvokeVoidAsync("updateMapMarker", selectedTrailer.SpottedLatitude.Value, selectedTrailer.SpottedLongitude.Value, selectedTrailer.SpottedAccuracy!.Value);
        }
    }

    private void SelectTrailer(TrailerViewModel trailer)
    {
        selectedTrailer = trailer;
        StateHasChanged();  // Trigger re-render for map update
    }

    private async Task ShowTrailerDetails()
    {
        Navigation.NavigateTo($"/trailer/{selectedTrailer.Id}");
        await Task.CompletedTask;
    }

    private async Task DeleteTrailer()
    {
        showDeleteModal = true;
        StateHasChanged();
    }

    private async Task SpotTrailer()
    {
        Navigation.NavigateTo($"/trailers/spot/{selectedTrailer.Prefix}/{selectedTrailer.Name}");
    }

    private async Task OnSpotTrailer(LocationUpdateResult result)
    {
        showSpotModal = false;
        TrailerViewModel? vm = await dataSource.Update(selectedTrailer.Id, new TrailerUpdateRequest
        {
            Latitude = result.Latititude,
            Longitude = result.Longitude,
            Accuracy = result.Accuracy,
            SpottedBy = "Austin Vandersluis"
        });

        if (vm != null)
        {
            selectedTrailer.Prefix = vm.Prefix;
            selectedTrailer.Name = vm.Name;
            selectedTrailer.SpottedLatitude = vm.SpottedLatitude;
            selectedTrailer.SpottedLongitude = vm.SpottedLongitude;
            selectedTrailer.SpottedAccuracy = vm.SpottedAccuracy;
            selectedTrailer.SpottedBy = vm.SpottedBy;
            selectedTrailer.SpottedOn = vm.SpottedOn;
        }
        StateHasChanged();
    }

    private async Task OnDeleteConfirmation(bool confirm)
    {
        if (confirm)
        {
            bool result = await dataSource.Delete(selectedTrailer.Id, null);

            if (result)
            {
                trailers.Remove(selectedTrailer);
                selectedTrailer = null;
                // Log Delete
            }
        }

        showDeleteModal = false;
        StateHasChanged();
    }
}