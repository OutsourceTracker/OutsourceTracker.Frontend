@page "/trailers/"
@page "/trailers/{TrailerId:guid?}"
@using Microsoft.JSInterop
@using OutsourceTracker.Models.Trailers
@using OutsourceTracker.Services
@using OutsourceTracker.Services.ModelService
@using OutsourceTracker.Tools
@using System.Text

<ConfirmationModal IsVisible="@showDeleteModal" Title="Confirm Delete" Message="Are you sure you want to delete this trailer?" OnResponse="OnDeleteConfirmation" YesButtonText="Delete" NoButtonText="Cancel" />
<div class="container-fluid p-3" style="height: calc(100vh - 80px); overflow: hidden;">
    <div class="row" style="height: 100%;">
        <!-- Left Side: Scrollable, Selectable Trailer List -->
        <div class="col-md-4 d-flex flex-column h-100 mobile-height-adjust">
            <h5 class="mb-2">Trailers</h5>
            <div class="list-group overflow-auto flex-grow-1 trailer-list">
                @if (trailers != null)
                {
                    @if (trailers.Any())
                    {
                        @foreach (var trailer in trailers)
                        {
                            <div id="@(trailer.Id.ToString("N"))" class="list-group-item list-group-item-action @(selectedTrailer?.Id == trailer.Id ? "active" : "")"
                                 @onclick="() => SelectTrailer(trailer)">
                                <div class="d-flex justify-content-between">
                                    <span>@trailer.Prefix @trailer.Name</span>
                                    <span>Status: @(trailer.State.ToString())</span>  @* Placeholder; fetch real data *@
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="p-3">There are no trailers :(</p>
                    }
                }
                else
                {
                    <p class="p-3">Loading trailers...</p>
                }
            </div>
        </div>

        <!-- Right Side: Details (Top) and Map (Bottom) -->
        <div class="col-md-8 d-flex flex-column h-100">
            <!-- Right Side Top: Trailer Details -->
            <div class="d-flex flex-column" style="flex: 0 0 auto; overflow-y: auto;">
                @* Fit to content with auto overflow *@
                <h5 class="mb-2">Details</h5>
                @if (selectedTrailer != null)
                {
                    <div class="card p-3">
                        <div class="row">
                            <div class="col-12 col-md-6"><strong>Prefix:</strong> @selectedTrailer.Prefix</div>
                            <div class="col-12 col-md-6"><strong>Number:</strong> @selectedTrailer.Name</div>
                        </div>
                        @if (selectedTrailer.Location.HasValue)
                        {
                            <div class="row mt-2">
                                <div class="col-12 col-md-6"><strong>Location:</strong> @(Math.Abs(selectedTrailer.Location.Value.X).ToString("F6")) @(selectedTrailer.Location.Value.X >= 0 ? "N" : "S") @(Math.Abs(selectedTrailer.Location.Value.Y).ToString("F6")) @(selectedTrailer.Location.Value.Y >= 0 ? "E" : "W") ± @(Math.Abs(selectedTrailer.LocationAccuracy!.Value).ToString("F6")) m</div>
                            </div>
                            <div class="row mt-2">
                                @if (selectedTrailer.LocatedDate.HasValue)
                                {
                                    <div class="col-12 col-md-6"><strong>Last Seen:</strong> @selectedTrailer.LocatedDate.Value.ToLocalTime()</div>
                                }
                                
                                @if (!string.IsNullOrWhiteSpace(selectedTrailer.LocatedBy))
                                {
                                    <div class="col-12 col-md-6"><strong>Seen By:</strong> @selectedTrailer.LocatedBy</div>
                                }
                            </div>
                        }
                        <div class="mt-3">
                            <button class="btn btn-primary me-1" @onclick="ShowTrailerDetails">Details</button>
                            <button class="btn btn-secondary me-2" @onclick="SpotTrailer">Spot</button>
                            <button class="btn btn-danger" @onclick="DeleteTrailer">Delete</button>
                        </div>
                    </div>
                }
                else
                {
                    <p class="p-3">Select a trailer to view details.</p>
                }
            </div>

            <!-- Right Side Bottom: Map -->
            <div class="d-flex flex-column mt-3 flex-grow-1">
                @* Expand to fill remaining space *@
                <h5 class="mb-2">Map</h5>
                <div id="map" class="border flex-grow-1" style="min-height: 0;"></div>
            </div>
        </div>
    </div>
</div>

@code {
    private List<TrailerViewModel> trailers;
    private TrailerViewModel? selectedTrailer;
    private bool mapInitialized = false;
    private bool showDeleteModal = false;
    private bool showSpotModal = false;
    [Inject] private IModelLookupService<TrailerViewModel> SearchService { get; set; } = null!;
    [Inject] private IModelDeleteService<TrailerViewModel> DeleteService { get; set; } = null!;
    [Inject] private NavigationManager Navigation { get; set; } = default!;
    [Inject] private IMapService Map { get; set; } = default!;
    [Parameter] public Guid? TrailerId { get; set; }

    protected override async Task OnInitializedAsync()
    {
        trailers = await SearchService.Search().ToListAsync();

        if (TrailerId.HasValue)
        {
            selectedTrailer = trailers.Find(t => t.Id == TrailerId.Value);
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await Map.InitializeMapAsync();
            mapInitialized = true;

            if (trailers != null)
            {
                foreach (var trailer in trailers)
                {
                    await SetTrailerMapMarker(trailer, false);
                }
            }

            if (selectedTrailer != null)
            {
                await SetTrailerMapMarker(selectedTrailer, true);
            }
        }
    }

    private async Task SetTrailerMapMarker(TrailerViewModel trailer, bool focus = false)
    {
        if (trailer.Location.HasValue)
        {
            StringBuilder info = new StringBuilder();
            info.Append("<div style=\"min-width=180px;\">")
            .AppendFormat("<strong>Name:</strong> {0}<br><br>", trailer.Prefix + trailer.Name);

            info.Append("<strong>Last Spotted</strong><br>");

            if (!string.IsNullOrWhiteSpace(trailer.LocatedBy)) info.AppendFormat("By: {0} | ", trailer.LocatedBy);
            if (trailer.LocatedDate.HasValue) info.AppendFormat("On: {0} | ", trailer.LocatedDate.Value.ToLocalTime().ToString("MM/dd/yyyy HH:mm"));
            info.AppendFormat("Accuracy: {0}", Math.Round(trailer.LocationAccuracy!.Value, 3));
            info.Append("</div>");
            await Map.CreateMapMarker(trailer.Id.ToString("N"), $"{trailer.Prefix}{trailer.Name}", trailer.Location.Value.X, trailer.Location.Value.Y, trailer.LocationAccuracy.Value, info.ToString());

            if (focus)
            {
                await Map.FocusMapMarker(trailer.Id.ToString("N"), null);
            }
        }
    }

    private async Task SelectTrailer(TrailerViewModel trailer)
    {
        if (selectedTrailer != trailer)
        {
            await Map.ClearMapMarkers();
            await SetTrailerMapMarker(trailer, true);
            selectedTrailer = trailer;
            StateHasChanged();
        }
    }

    private async Task ShowTrailerDetails()
    {
        Navigation.NavigateTo($"/trailer/{selectedTrailer?.Id}");
        await Task.CompletedTask;
    }

    private async Task DeleteTrailer()
    {
        showDeleteModal = true;
        StateHasChanged();
    }

    private async Task SpotTrailer()
    {
        Navigation.NavigateTo($"/trailer/spot/{selectedTrailer.Prefix}/{selectedTrailer.Name}");
    }

    private async Task OnDeleteConfirmation(bool confirm)
    {
        if (confirm && selectedTrailer != null)
        {
            bool result = await DeleteService.Delete(selectedTrailer.Id);

            if (result)
            {
                trailers.Remove(selectedTrailer);
                await Map.DeleteMapMarker(selectedTrailer.Id.ToString("N"));
                selectedTrailer = null;
            }
        }

        showDeleteModal = false;
        StateHasChanged();
    }
}