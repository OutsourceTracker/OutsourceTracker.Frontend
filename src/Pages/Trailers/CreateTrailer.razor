@page "/trailer/create"
@using OutsourceTracker.Models.Trailers
@using OutsourceTracker.Services
@using OutsourceTracker.Services.ModelService

<PageTitle>New Trailer</PageTitle>

<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-7 col-xl-6">
            <div class="card shadow-lg border-0 rounded-4 overflow-hidden">
                <div class="card-header bg-primary bg-gradient text-white py-4">
                    <h3 class="mb-0 fw-semibold text-center">New Trailer Registration</h3>
                </div>
                <div class="card-body p-4 p-md-5">
                    @if (!string.IsNullOrEmpty(message))
                    {
                        <div class="alert alert-@messageType alert-dismissible fade show mb-4" role="alert">
                            @message
                            <button type="button" class="btn-close" @onclick="() => { message = null; messageType = null; }"></button>
                        </div>
                    }

                    <EditForm Model="@request" OnValidSubmit="HandleValidSubmit" FormName="trailerCreate">
                        <DataAnnotationsValidator />
                        <ValidationSummary class="text-danger mb-4" />

                        <!-- Prefix -->
                        <div class="form-floating mb-4">
                            <InputText id="prefix"
                                       @bind-Value="request.Prefix"
                                       @oninput="@(e => request.Prefix = e.Value?.ToString()?.ToUpperInvariant())"
                                       class="form-control"
                                       placeholder="JBHZ" />
                            <label for="prefix">Prefix <span class="text-danger">*</span></label>
                            <ValidationMessage For="@(() => request.Prefix)" />
                            <div class="form-text text-muted mt-1 small">
                                e.g. JBHZ, JBHU, JBRU – organizational/unit identifier
                            </div>
                        </div>

                        <!-- Trailer Number/Name -->
                        <div class="form-floating mb-5">
                            <InputText id="name"
                                       @bind-Value="request.Name"
                                       @oninput="@(e => request.Name = e.Value?.ToString()?.ToUpperInvariant())"
                                       class="form-control" />
                            <label for="name">Trailer Number <span class="text-danger">*</span></label>
                            <ValidationMessage For="@(() => request.Name)" />
                            <div class="form-text text-muted mt-1 small">
                                Unique identifier (e.g. 056779)
                            </div>
                        </div>

                        <!-- Responsive "table-like" preview of what will be created -->
                        <div class="border rounded p-3 mb-4 bg-light">
                            <h6 class="mb-3 text-muted">Preview</h6>
                            <div class="d-flex flex-column flex-sm-row gap-3 justify-content-between">
                                <div class="d-flex flex-column">
                                    <span class="text-muted small">Prefix</span>
                                    <strong>@(string.IsNullOrWhiteSpace(request.Prefix) ? "—" : request.Prefix)</strong>
                                </div>
                                <div class="d-flex flex-column">
                                    <span class="text-muted small">Trailer</span>
                                    <strong>@(string.IsNullOrWhiteSpace(request.Name) ? "—" : request.Name)</strong>
                                </div>
                                <div class="d-flex flex-column">
                                    <span class="text-muted small">Combined ID</span>
                                    <strong>@GetCombinedId()</strong>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex flex-column flex-sm-row gap-3 justify-content-end mt-5">
                            <button type="button"
                                    class="btn btn-outline-secondary btn-lg px-5 py-3"
                                    @onclick='() => Navigation.NavigateTo("/trailers")'
                                    disabled="@isSubmitting">
                                Cancel
                            </button>
                            <button type="submit"
                                    class="btn btn-primary btn-lg px-5 py-3 fw-semibold"
                                    disabled="@isSubmitting">
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true" style="@(isSubmitting ? "" : "display:none")"></span>
                                @(isSubmitting ? "Creating..." : "Create Trailer")
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private TrailerCreateObject request = new();
    private bool isSubmitting = false;
    private string? message;
    private string? messageType; // "success" or "danger"

    [Inject] private TrailerService TrailerService { get; init; } = default!;
    [Inject] private NavigationManager Navigation { get; set; } = default!;

    private string GetCombinedId()
    {
        if (string.IsNullOrWhiteSpace(request.Prefix))
            return request.Name ?? "—";

        return $"{request.Prefix.Trim()} {request.Name?.Trim() ?? "?"}";
    }

    private async Task HandleValidSubmit()
    {
        isSubmitting = true;
        message = null;
        messageType = null;

        try
        {
            if (request == null)
            {
                message = "Request object is null";
                messageType = "danger";
                return;
            }
            else if (string.IsNullOrWhiteSpace(request.Prefix))
            {
                message = "Missing required field: Prefix";
                messageType = "danger";
                return;
            }
            else if (string.IsNullOrWhiteSpace(request.Name))
            {
                message = "Missing required field: Name";
                messageType = "danger";
                return;
            }

            HttpResponseMessage response = await TrailerService.Create();
            response.EnsureSuccessStatusCode();
            Guid? instanceId = await response.Content.ReadFromJsonAsync<Guid>();

            if (instanceId.HasValue)
            {
                await TrailerService.Update(instanceId.Value, request);
                message = "Trailer created successfully!";
                messageType = "success";
                Navigation.NavigateTo($"/trailer/{instanceId}");
            }
            else
            {
                message = "API service didn't return a valid ID";
                messageType = "danger";
            }
        }
        catch (Exception ex)
        {
            message = $"Error: {ex.Message}";
            messageType = "danger";
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }

    private class TrailerCreateObject
    {
        public string? Prefix { get; set; }

        public string? Name { get; set; }
    }
}