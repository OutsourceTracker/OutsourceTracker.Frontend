@page "/trailers/"
@page "/trailers/{TrailerId:guid?}"
@attribute [Authorize(Roles = "Trailers.Read,Trailers.Write,Trailers.UpdateLocation")]
@using Microsoft.AspNetCore.Authorization
@using OutsourceTracker.Models.Trailers
@using OutsourceTracker.Services
@using OutsourceTracker.Tools
@using OutsourceTracker.Pages.Trailers.Components

<PageTitle>Trailers • Outsource Tracker</PageTitle>

<ConfirmationModal @bind-IsVisible="showDeleteModal"
                   Title="Confirm Delete"
                   Message="Are you sure you want to delete this trailer?"
                   YesButtonText="Delete"
                   YesButtonClass="btn-danger"
                   OnResponse="OnDeleteConfirmation" />

<div class="container-fluid h-100 trailers-page-container p-0">
    <div class="row g-0 h-100">
        <!-- Left column – list -->
        <div class="col-lg-4 col-xl-3 d-flex flex-column border-end trailer-list-column">
            <div class="p-3 border-bottom bg-light">
                <h5 class="mb-0 d-flex justify-content-between align-items-center">
                    Trailers
                    <a href="/trailer/create" class="btn btn-sm btn-primary">
                        <i class="bi bi-plus-lg"></i> New
                    </a>
                </h5>
            </div>

            <TrailerList @ref="trailerList"
                         Trailers="trailers"
                         SelectedId="selectedTrailer?.Id"
                         OnTrailerSelected="SelectTrailerAsync" />
        </div>

        <!-- Right column – detail + map -->
        <div class="col-lg-8 col-xl-9 d-flex flex-column">
            <!-- Detail card – grows only as needed -->
            <div class="p-3 border-bottom bg-white detail-section">
                <h5 class="mb-3">Trailer Details</h5>

                <TrailerDetailCard Trailer="selectedTrailer"
                                   OnShowDetails="ShowTrailerDetails"
                                   OnSpot="SpotTrailer"
                                   OnDelete="() => showDeleteModal = true" />
            </div>

            <!-- Map – takes remaining space -->
            <div class="flex-grow-1 d-flex flex-column p-3 pt-0 map-section">
                <h5 class="mb-3">Location Map</h5>
                <TrailerMap @ref="trailerMap"
                            Height="100%"
                            SelectedTrailer="selectedTrailer"
                            AllTrailers="trailers" />
            </div>
        </div>
    </div>
</div>

@code {
    [Inject] private TrailerService TrailerService { get; set; } = null!;
    [Inject] private NavigationManager Navigation { get; set; } = null!;
    [Inject] private IMapService Map { get; set; } = null!;

    private List<TrailerViewModel>? trailers;
    private TrailerViewModel? selectedTrailer;
    private bool showDeleteModal;

    private TrailerList? trailerList;
    private TrailerMap? trailerMap;

    [Parameter] public Guid? TrailerId { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await Map.InitializeMapAsync();
            StateHasChanged();
            return;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        trailers = await TrailerService.Search().ToListAsync();

        if (TrailerId.HasValue)
        {
            var trailer = trailers?.FirstOrDefault(t => t.Id == TrailerId.Value);
            await SelectTrailerAsync(trailer);
        }
    }

    private async Task SelectTrailerAsync(TrailerViewModel? trailer)
    {
        if (trailer == selectedTrailer) return;

        if (selectedTrailer != null)
        {
            await trailerMap.RemoveMarkerAsync(selectedTrailer.Id.ToString("N"));
        }

        selectedTrailer = trailer;

        if (trailer != null)
        {
            await trailerMap?.FocusOnTrailerAsync(trailer);
        }
        else
        {
            await trailerMap?.ClearFocusAsync();
        }
    }

    private void ShowTrailerDetails()
    {
        if (selectedTrailer is null) return;
        Navigation.NavigateTo($"/trailer/{selectedTrailer.Id}");
    }

    private void SpotTrailer()
    {
        if (selectedTrailer is null) return;
        Navigation.NavigateTo($"/trailer/spot/{selectedTrailer.Prefix}/{selectedTrailer.Name}");
    }

    private async Task OnDeleteConfirmation(bool confirmed)
    {
        if (!confirmed || selectedTrailer is null) return;

        var result = await TrailerService.Delete(selectedTrailer.Id);

        if (result.IsSuccessStatusCode)
        {
            trailers?.Remove(selectedTrailer);
            await trailerList?.RefreshAsync();
            await trailerMap?.RemoveMarkerAsync(selectedTrailer.Id.ToString("N"));
            selectedTrailer = null;
        }

        showDeleteModal = false;
    }
}