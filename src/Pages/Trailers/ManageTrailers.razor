@page "/trailers/"
@page "/trailers/{TrailerId:guid?}"
@using Microsoft.AspNetCore.Authorization
@using OutsourceTracker.Models.Trailers
@using OutsourceTracker.Services
@using OutsourceTracker.Pages.Trailers.Components
@attribute [Authorize(Roles = "Trailers.Read,Trailers.Write,Trailers.UpdateLocation")]

<PageTitle>Trailers • Outsource Tracker</PageTitle>

<TrailerSpotModal @ref="spotModal" SelectedTrailers="selectedTrailers" OnLocationUpdated="RefreshTrailerList" />
<ConfirmationModal @bind-IsVisible="showDeleteModal"
                   Title="Confirm Delete"
                   Message="Are you sure you want to delete this trailer?"
                   YesButtonText="Delete"
                   YesButtonClass="btn-danger"
                   OnResponse="OnDeleteConfirmation" />

<div class="container-fluid h-100 trailers-page-container p-0">
    <div class="row g-0 h-100">
        <!-- Left column – list -->
        <div class="col-lg-4 col-xl-3 d-flex flex-column border-end trailer-list-column">
            <div class="p-3 border-bottom bg-light d-flex justify-content-between align-items-center flex-wrap gap-2">
                <h5 class="mb-0">
                    Trailers 
                    @if (selectedTrailers.Count > 0)
                    {
                        <span class="badge bg-primary ms-2">@selectedTrailers.Count selected</span>
                    }
                </h5>

                <div class="btn-group btn-group-sm" role="group">
                    @if (selectedTrailers.Any())
                    {
                        <button class="btn btn-success" @onclick="ShowSpotModalForSelected">
                            <i class="bi bi-geo-alt-fill me-1"></i>Spot Selected
                        </button>
                        <button class="btn btn-outline-secondary" @onclick="ClearSelection">
                            Clear
                        </button>
                    }
                    <a href="/trailer/create" class="btn btn-primary">
                        <i class="bi bi-plus-lg"></i> New
                    </a>
                </div>
            </div>

            <TrailerList @ref="trailerList"
                         Trailers="trailers"
                         SelectedId="selectedTrailer?.Id"
                         SelectedTrailers="selectedTrailers"
                         OnTrailerSelected="SelectTrailerAsync"
                         OnToggleSelection="ToggleTrailerInSelection" />
        </div>

        <!-- Right column – detail + map -->
        <div class="col-lg-8 col-xl-9 d-flex flex-column">
            <div class="p-3 border-bottom bg-white detail-section">
                <h5 class="mb-3">Trailer Details</h5>
                <TrailerDetailCard Trailer="selectedTrailer"
                                   OnShowDetails="ShowTrailerDetails"
                                   OnSpot="SpotSingleTrailer"
                                   OnDelete="() => showDeleteModal = true" />
            </div>

            <div class="flex-grow-1 d-flex flex-column p-3 pt-0 map-section">
                <h5 class="mb-3">Location Map</h5>
                <TrailerMap @ref="trailerMap"
                            Height="100%"
                            SelectedTrailer="selectedTrailer"
                            AllTrailers="trailers" />
            </div>
        </div>
    </div>
</div>

@code {
    [Inject] private TrailerService TrailerService { get; set; } = null!;
    [Inject] private NavigationManager Navigation { get; set; } = null!;
    [Inject] private IMapService Map { get; set; } = null!;

    private List<TrailerViewModel>? trailers;
    private TrailerViewModel? selectedTrailer;
    private List<TrailerViewModel> selectedTrailers = new();

    private bool showDeleteModal;

    private TrailerList? trailerList;
    private TrailerMap? trailerMap;
    private TrailerSpotModal? spotModal;

    [Parameter] public Guid? TrailerId { get; set; }

    protected override async Task OnInitializedAsync() => await RefreshTrailerList();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await Map.InitializeMapAsync();
            StateHasChanged();
        }
    }

    private async Task SelectTrailerAsync(TrailerViewModel? trailer)
    {
        if (trailer == selectedTrailer) return;

        if (selectedTrailer != null)
        {
            await trailerMap?.RemoveMarkerAsync(selectedTrailer.Id.ToString("N"));
        }

        selectedTrailer = trailer;

        if (trailer != null)
        {
            await trailerMap?.FocusOnTrailerAsync(trailer);
        }
        else
        {
            await trailerMap?.ClearFocusAsync();
        }
    }

    private async Task ToggleTrailerInSelection(TrailerViewModel trailer)
    {
        if (selectedTrailers.Any(t => t.Id == trailer.Id))
        {
            selectedTrailers.RemoveAll(t => t.Id == trailer.Id);
        }
        else
        {
            selectedTrailers.Add(trailer);
        }

        StateHasChanged();
    }

    private async Task RefreshTrailerList()
    {
        selectedTrailer = null;
        selectedTrailers.Clear();
        trailers = await TrailerService.Search()
            .OrderByDescending(t => t.LocatedDate.HasValue)
            .ThenByDescending(t => t.LocatedDate)
            .ToListAsync();

        if (TrailerId.HasValue)
        {
            selectedTrailer = trailers?.FirstOrDefault(t => t.Id == TrailerId);
        }
    }

    private void HandleSelectionChange()
    {
        StateHasChanged();
    }

    private void ClearSelection()
    {
        selectedTrailers.Clear();
        StateHasChanged();
    }

    private async Task ShowSpotModalForSelected()
    {
        if (spotModal != null && selectedTrailers.Any())
        {
            await spotModal.Show();
        }
    }

    private async Task SpotSingleTrailer()
    {
        if (selectedTrailer is null) return;

        // For consistency: use the same multi-spot modal even for single trailer
        selectedTrailers.Clear();
        selectedTrailers.Add(selectedTrailer);
        await spotModal?.Show();

        // Alternative (if you prefer redirect):
        // Navigation.NavigateTo($"/trailer/spot/{selectedTrailer.Prefix}/{selectedTrailer.Name}");
    }

    private void ShowTrailerDetails()
    {
        if (selectedTrailer is null) return;
        Navigation.NavigateTo($"/trailer/{selectedTrailer.Id}");
    }

    private async Task OnDeleteConfirmation(bool confirmed)
    {
        if (!confirmed || selectedTrailer is null) return;

        var result = await TrailerService.Delete(selectedTrailer.Id);

        if (result.IsSuccessStatusCode)
        {
            trailers?.Remove(selectedTrailer);
            selectedTrailers.Remove(selectedTrailer);
            await trailerList?.RefreshAsync();
            await trailerMap?.RemoveMarkerAsync(selectedTrailer.Id.ToString("N"));
            selectedTrailer = null;
        }

        showDeleteModal = false;
        StateHasChanged();
    }
}