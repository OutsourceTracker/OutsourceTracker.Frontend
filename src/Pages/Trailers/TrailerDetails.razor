@page "/trailer/{Id:guid}"
@attribute [Authorize(Roles = "Trailers.Read")]
@using Microsoft.AspNetCore.Authorization
@using OutsourceTracker.Models.Trailers
@using OutsourceTracker.Services
@using OutsourceTracker.Tools
@inject TrailerService TrailerService
@inject NavigationManager Navigation
@inject IMapService MapService

<PageTitle>Trailer @trailer?.Prefix@trailer?.Name - Outsource Tracker</PageTitle>

<div class="container-fluid py-4 py-md-5 trailer-detail-page">
    <div class="row justify-content-center">
        <div class="col-xl-10 col-xxl-9">

            <!-- Header Card -->
            <div class="card shadow border-0 rounded-4 overflow-hidden mb-4">
                <div class="card-header bg-gradient bg-primary text-white d-flex justify-content-between align-items-center py-4 px-4 px-md-5">
                    <div>
                        <h3 class="mb-1 fw-semibold">Trailer Details</h3>
                        <div class="fs-5 opacity-75">@(trailer != null ? $"{trailer.Prefix}{trailer.Name}" : "Loading...")</div>
                    </div>
                    <a href="/trailers" class="btn btn-outline-light px-4">
                        <i class="bi bi-arrow-left me-2"></i>Back to List
                    </a>
                </div>

                @if (isLoading)
                {
                    <div class="card-body text-center py-5 my-5">
                        <div class="spinner-border text-primary spinner-border-lg" role="status">
                            <span class="visually-hidden">Loading trailer...</span>
                        </div>
                        <h5 class="mt-4 text-muted">Loading trailer information</h5>
                        <p class="text-muted">Please wait a moment...</p>
                    </div>
                }
                else if (trailer == null)
                {
                    <div class="card-body text-center py-5 my-5">
                        <i class="bi bi-exclamation-triangle-fill text-danger" style="font-size: 4rem;"></i>
                        <h4 class="mt-4 mb-3 text-danger">Trailer Not Found</h4>
                        <p class="lead text-muted mb-4">The trailer you're looking for doesn't exist or you don't have access.</p>
                        <a href="/trailers" class="btn btn-outline-primary btn-lg px-5">
                            Return to Trailers List
                        </a>
                    </div>
                }
                else
                {
                    <div class="card-body p-4 p-md-5">
                        <div class="row g-4 mb-5">
                            <!-- Left Column - Identification & Status -->
                            <div class="col-lg-5">
                                <div class="card border shadow-sm h-100">
                                    <div class="card-body">
                                        <h5 class="card-title fw-bold mb-4 text-primary">Identification</h5>
                                        <div class="row g-3">
                                            <div class="col-6">
                                                <label class="text-muted small d-block mb-1">Prefix</label>
                                                <div class="fs-4 fw-bold text-uppercase">@trailer.Prefix</div>
                                            </div>
                                            <div class="col-6">
                                                <label class="text-muted small d-block mb-1">Number</label>
                                                <div class="fs-4 fw-bold text-uppercase">@trailer.Name</div>
                                            </div>
                                            <div class="col-12">
                                                <label class="text-muted small d-block mb-1">Full ID</label>
                                                <div class="fs-5 fw-semibold">@($"{trailer.Prefix}{trailer.Name}")</div>
                                            </div>
                                            <div class="col-12">
                                                <label class="text-muted small d-block mb-1">Current State</label>
                                                <span class="badge bg-info fs-6 px-3 py-2">@trailer.State</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Right Column - Last Known Location -->
                            <div class="col-lg-7">
                                <div class="card border shadow-sm h-100">
                                    <div class="card-body">
                                        <h5 class="card-title fw-bold mb-4 text-primary">Last Known Location</h5>

                                        @if (trailer.Location.HasValue && trailer.LocatedDate.HasValue)
                                        {
                                            <div class="row g-3">
                                                <div class="col-sm-6">
                                                    <label class="text-muted small d-block mb-1">Coordinates</label>
                                                    <div class="fs-5">
                                                        @(Math.Abs(trailer.Location.Value.X).ToString("F6"))° @(trailer.Location.Value.X >= 0 ? "N" : "S"),
                                                        @(Math.Abs(trailer.Location.Value.Y).ToString("F6"))° @(trailer.Location.Value.Y >= 0 ? "E" : "W")
                                                    </div>
                                                </div>
                                                <div class="col-sm-6">
                                                    <label class="text-muted small d-block mb-1">Accuracy</label>
                                                    <div class="fs-5">@($"{trailer.LocationAccuracy:F0} meters")</div>
                                                </div>
                                                <div class="col-sm-6">
                                                    <label class="text-muted small d-block mb-1">Last Seen</label>
                                                    <div class="fs-5">@trailer.LocatedDate.Value.ToLocalTime().ToString("MMM dd, yyyy · HH:mm")</div>
                                                </div>
                                                <div class="col-sm-6">
                                                    <label class="text-muted small d-block mb-1">Spotted By</label>
                                                    <div class="fs-5">@(trailer.LocatedBy ?? "Unknown")</div>
                                                </div>
                                                <div class="col-sm-6">
                                                    <label class="text-muted small d-block mb-1">Active Zone</label>
                                                    <div class="fs-5">@(trailer.ZoneName ?? "Not In Zone")</div>
                                                </div>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="alert alert-warning mb-0">
                                                <i class="bi bi-info-circle me-2"></i>
                                                No location data has been recorded for this trailer yet.
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Map -->
                        <div class="card border shadow-sm mb-5">
                            <div class="card-header bg-light fw-semibold">
                                Current / Last Known Position
                            </div>
                            <div class="position-relative" style="height: 500px;">
                                <div id="map" style="height: 100%;"></div>

                                @if (!trailer.Location.HasValue)
                                {
                                    <div class="position-absolute top-50 start-50 translate-middle text-center bg-white p-4 rounded shadow">
                                        <i class="bi bi-geo-alt-slash fs-1 text-muted mb-3 d-block"></i>
                                        <h5 class="text-muted">No location available</h5>
                                    </div>
                                }
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex flex-wrap gap-3 justify-content-end">
                            <button class="btn btn-primary btn-lg px-5"
                                    @onclick='() => Navigation.NavigateTo($"/trailer/spot/{trailer.Prefix}/{trailer.Name}")'>
                                <i class="bi bi-geo-alt-fill me-2"></i>Update Location
                            </button>

                            <button class="btn btn-outline-secondary btn-lg px-5"
                                    @onclick='() => Navigation.NavigateTo($"/trailer/{Id}/edit")'>
                                <i class="bi bi-pencil me-2"></i>Edit Trailer
                            </button>

                            <button class="btn btn-outline-danger btn-lg px-5"
                                    @onclick="ShowDeleteModal">
                                <i class="bi bi-trash me-2"></i>Delete Trailer
                            </button>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<ConfirmationModal @bind-IsVisible="showDeleteModal"
                   Title="Delete Trailer"
                   YesButtonText="Delete"
                   YesButtonClass="btn-danger"
                   NoButtonText="Cancel"
                   OnResponse="HandleDeleteResponse">
    <p>Are you sure you want to permanently delete trailer <strong>@($"{trailer?.Prefix}{trailer?.Name}")</strong>?</p>
    <p class="text-danger fw-bold mb-0">This action cannot be undone.</p>
</ConfirmationModal>

@code {
    [Parameter] public Guid Id { get; set; }

    private TrailerViewModel? trailer;
    private bool isLoading = true;
    private bool showDeleteModal = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            trailer = await TrailerService.Get(Id);
        }
        catch (Exception ex)
        {
            // You might want to add a proper error toast/notification here later
            Console.WriteLine($"Failed to load trailer {Id}: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await MapService.InitializeMapAsync();
            StateHasChanged();
            return;
        }

        if (trailer?.Location.HasValue == true && !firstRender)
        {
            await MapService.ClearMapMarkers();

            var infoHtml = $@"
                <div style='min-width:220px;'>
                    <strong>{trailer.Prefix}{trailer.Name}</strong><br><br>
                    <strong>Last spotted:</strong><br>
                    {trailer.LocatedDate?.ToLocalTime():MMM dd, yyyy HH:mm}<br>
                    By: {trailer.LocatedBy ?? "—"}<br>
                    Accuracy: {trailer.LocationAccuracy:F1} m
                </div>";

            await MapService.CreateMapMarker(
                trailer.Id.ToString("N"),
                $"{trailer.Prefix}{trailer.Name}",
                trailer.Location.Value.X,
                trailer.Location.Value.Y,
                trailer.LocationAccuracy ?? 100,
                infoHtml);

            await MapService.FocusMapMarker(trailer.Id.ToString("N"), 14); // reasonable zoom for single marker
        }
    }

    private void ShowDeleteModal() => showDeleteModal = true;

    private async Task HandleDeleteResponse(bool confirmed)
    {
        if (!confirmed || trailer == null) return;

        try
        {
            var success = await TrailerService.Delete(Id);
            if (success.IsSuccessStatusCode)
            {
                Navigation.NavigateTo("/trailers", forceLoad: true);
            }
            else
            {
                // TODO: show error message / toast
                Console.WriteLine("Delete returned false");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Delete failed: {ex.Message}");
            // TODO: show user-facing error
        }
    }
}